# ✒️ Server State

#### Server State란 무엇인가?

1. state (상태)

- React에서는 렌더링에 영향을 미치는 JS Object 라고 정의.
- Global State (전역 상태) 는 어플리케이션 어디에서든 접근이 가능하고, 이의 변화는 곧 전반적으로 애플리케이션의 렌더링에 영향을 미침.

2. Client State

- UI 테마, 사이드바, 폼 입력 등과 같이 클라이언트가 소유하고 제어하는 데이터를 의미.
- 클라이언트에서 항상 제어가 가능하기에 항상 동기적인 상태를 가짐.
  - local client state : 폼 입력, 사이드바 같이 하나 또는 인접한 컴포넌트에서 사용하는 state.
  - global client state : 언어, UI 테마 (다크 모드) 와 같이 어플리케이션에 전반적으로 사용되는 state.

3. Server State

- 유저 DB 정보 등과 같이 클라이언트가 서버로부터 받아오는 모든 데이터를 의미함.
- 클라이언트가 제어하고 관리할 수 없기에 **특정 시점**으로부터 받아온 데이터를 사용함. 이로 인해 비동기적인 상태를 가짐.
- 서버와 클라이언트 간의 state가 항상 일치한다는 보장이 없으며, 클라이언트에서 더 이상 **유효하지 않은 데이터**를 소유할 가능성이 있음.

# ✒️ Why React Query?

#### 1. React Query 가 대체 뭔가?

> **fetching, caching, synchronizing and updating server state** in your React applications - tanstack

- react-query는 서버에서부터 데이터를 fetching하고, 동기화하는 라이브러리이다.
- 서버로부터 받아온 데이터를 별도의 키를 통해 관리하고, 캐싱하는 역할도 한다.
- 사용자의 로직에 따라 필요한 데이터를 서버 쪽에서 받아와 백그라운드에서 업데이트 (refetch) 하는 기능을 한다.

#### 2. 이걸 왜 써야 하는가?

1. Client state와 Server state의 완전한 분리.

- 일반적으로 서버에서 받아온 server state의 경우 전역으로 관리하는 것이 합리적임.
- state를 필요로 하는 모든 컴포넌트에서 개별적인 API 호출을 하는 것은 비용 낭비임.
- 여러 컴포넌트에서 state를 공유하기 위해 props drilling 을 사용하는 것도 한계가 있음.
- 따라서 전역 스토어에서 server state를 마치 cache 처럼 관리한다면 훨씬 접근이 용이함.
- Redux를 사용할 경우 서버에서 데이터를 받아와 상태 관리를 하기 위해 Redux-Saga가 필요함. 이로 인해 관련 로직 및 모듈이 비대해짐.

2. server state의 비동기적인 특성 때문.

- 전역 상태 관리 라이브러리의 경우, 서버의 데이터와 다른 값을 보유할 수도 있다.
- 그에 대한 이유는 앞서 말한 server state의 비동기적인 특성 때문이다.
- 또한, 서버에서 받아온 데이터는 로드된 시간의 "스냅샷" 에 불과하다.

  - fetch, update를 위한 별도의 비동기 API가 필요함.
  - 지속적인 관찰이 미비할 경우 오래된 데이터로 취급될 수 있음.
  - 다른 사용자에 의해 서버 단에서 데이터가 변경될 수 있음.
  - 기본적으로 클라이언트가 관리할 수 없는 영역에 위치해 있음.

- 추가적으로 클라이언트에서 보유 중인 데이터가 아직 유효한지를 확인하는 것도 어렵다.
- 왜냐하면 서버에서 특정 데이터에 대한 변경이 이루어지더라도 클라이언트에서 이를 즉시 확인할 방법이 없기 때문이다.
- 따라서 server state를 원활하게 다루기 위해서는 아래와 같은 조건이 선행되어야 한다.

  - 서버로부터 받은 데이터를 캐싱
  - 동일한 데이터에 대한 여러 요청을 단일 요청으로 변환
  - 백그라운드 단에서 오래된 데이터를 자동으로 업데이트
  - 데이터가 언제 오래된 (stale) 상태가 되었는지 확인.
  - 서버로부터 받은 데이터를 관리하고, GC로부터 언제 처리되는지 관리.

3. server state를 훨씬 쉽게 관리할 수 있음.

- react query의 경우 상단의 기능을 지원하는 라이브러리이며, 로직 또한 단순한 축에 속한다.
- 현재 데이터가 fetching 되었는지, 데이터가 불러오는 과정에서 에러가 발생하였는지를 쉽게 체크할 수 있다.

# ✒️ Structure of React Query

state : fresh, stale, inactive (캐싱된 데이터에 대한 상태)
fetchState : fetching, paused, idle (query Function에 대한 상태, 현재 실행 중인지 아닌지?)
